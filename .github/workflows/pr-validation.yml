name: Pull Request Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.cache/ms-playwright

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  quick-validation:
    name: Quick Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: |
          echo "Running code linting..."
          npm run lint:check || npm run lint || true

      - name: Type checking
        run: |
          echo "Running type checking..."
          npm run type-check

      - name: Security audit (high/critical will fail)
        run: npm audit --audit-level=high

  pr-smoke-tests:
    name: PR Smoke Tests
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: Checkout PR
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run smoke tests
        run: npm run test:ci:smoke
        env:
          CI: true
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Upload Playwright traces on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: traces-pr-smoke
          path: |
            test-results/
            reports/test-execution/**/playwright-report/
          retention-days: 3

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: pr-smoke-test-results
          path: |
            reports/
            test-results/
          retention-days: 3

      - name: PR job summary
        if: always()
        run: |
          node -e '
          const fs = require("fs");
          const path = require("path");
          const reportPath = path.join("reports","test-execution","development","test-results.json");
          const totals = { total: 0, passed: 0, failed: 0, skipped: 0 };
          function walkSuite(suite){
            for(const s of suite.suites||[]) walkSuite(s);
            for(const spec of suite.specs||[]){
              for(const test of spec.tests||[]){
                totals.total++;
                const res = (test.results && test.results[0]) || {};
                const st = res.status || test.status || "unknown";
                if(st === "passed") totals.passed++;
                else if(st === "skipped" || st === "interrupted") totals.skipped++;
                else totals.failed++;
              }
            }
          }
          try{
            if(fs.existsSync(reportPath)){
              const data = JSON.parse(fs.readFileSync(reportPath, "utf8"));
              if(data && Array.isArray(data.suites)) walkSuite({ suites: data.suites });
            }
          }catch(e){}
          const lines = [];
          lines.push("# PR Smoke Test Summary");
          lines.push("");
          lines.push("| Metric | Count |");
          lines.push("|---|---|");
          lines.push(`| Total | ${totals.total} |`);
          lines.push(`| Passed | ${totals.passed} |`);
          lines.push(`| Failed | ${totals.failed} |`);
          lines.push(`| Skipped | ${totals.skipped} |`);
          lines.push("");
          lines.push(`View workflow and artifacts: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`);
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, lines.join("\n") + "\n");
          '

      - name: Comment PR with results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(cat << 'EOF'
          ## PR Smoke Test Results

          See the job summary and artifacts for details.

          EOF
          )
          BODY+=$'\nRun: '${{ github.server_url }}'/'${{ github.repository }}'/actions/runs/'${{ github.run_id }}
          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "$(jq -nc --arg body "$BODY" '{ body: $body }')"

  pr-api-tests:
    name: PR API Tests
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: Checkout PR
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run API tests
        run: npm run test:api:comprehensive
        env:
          CI: true
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Upload API test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: pr-api-test-results
          path: |
            reports/api-tests/
            reports/newman/
          retention-days: 3
