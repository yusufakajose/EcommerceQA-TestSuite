#!/usr/bin/env sh

# Block pushing commits authored/committed by disallowed identities,
# but only for the commits actually being pushed (from stdin).
# See: https://git-scm.com/docs/githooks#_pre_push

# POSIX sh: avoid bash-only options like 'pipefail'
set -eu

REMOTE_NAME=${1:-origin}
REMOTE_URL=${2:-}

DISALLOWED_NAMES='^(ci-bot)$'
DISALLOWED_EMAILS='^(ci@example\.com)$'

err=0

# Read ref updates from stdin: <local-ref> <local-oid> <remote-ref> <remote-oid>
while read -r local_ref local_oid remote_ref remote_oid; do
  # Deletion: local_oid is all zeros -> nothing new to check
  if printf %s "$local_oid" | grep -qE '^[0]{40}$'; then
    continue
  fi

  # Compute range of commits to be pushed for this ref update
  if printf %s "$remote_oid" | grep -qE '^[0]{40}$'; then
    # New branch/tag on remote: conservatively list commits reachable from new tip
    RANGE_COMMITS=$(git rev-list "$local_oid" --not --remotes="$REMOTE_NAME" 2>/dev/null || true)
  else
    # Normal update: commits in old..new
    RANGE_COMMITS=$(git rev-list "$remote_oid".."$local_oid" 2>/dev/null || true)
  fi

  # If range couldn't be determined (e.g., shallow), fall back to last 50 from the new tip
  if [ -z "${RANGE_COMMITS:-}" ]; then
    RANGE_COMMITS=$(git rev-list -n 50 "$local_oid" 2>/dev/null || true)
  fi

  # Inspect commits
  if [ -n "${RANGE_COMMITS:-}" ]; then
    # For each commit, check author/committer name/email (portable, no xargs)
    for sha in $RANGE_COMMITS; do
      line=$(git log -n 1 --format='%H|%an|%ae|%cn|%ce' "$sha" 2>/dev/null || true)
      [ -n "$line" ] || continue
      an=$(printf '%s' "$line" | cut -d'|' -f2)
      ae=$(printf '%s' "$line" | cut -d'|' -f3)
      cn=$(printf '%s' "$line" | cut -d'|' -f4)
      ce=$(printf '%s' "$line" | cut -d'|' -f5)
      if printf %s "$an" | grep -Eqi "$DISALLOWED_NAMES"; then
        echo "Push blocked: disallowed author name in $sha: $an" >&2; err=1; fi
      if printf %s "$cn" | grep -Eqi "$DISALLOWED_NAMES"; then
        echo "Push blocked: disallowed committer name in $sha: $cn" >&2; err=1; fi
      if printf %s "$ae" | grep -Eqi "$DISALLOWED_EMAILS"; then
        echo "Push blocked: disallowed author email in $sha: $ae" >&2; err=1; fi
      if printf %s "$ce" | grep -Eqi "$DISALLOWED_EMAILS"; then
        echo "Push blocked: disallowed committer email in $sha: $ce" >&2; err=1; fi
    done
  fi
done

exit "$err"
